{% extends "base.html" %}
{% block title %}Admin Dashboard - UPI Fraud Shield{% endblock %}
{% block content %}
<div class="container-fluid p-0 page-container">
    <div class="container py-4">
        <div class="card">
            <div class="card-body">
                <h1 class="text-gradient text-primary mb-4 dashboard-header">
                    <i class="fas fa-shield-alt me-2"></i>Admin Dashboard
                </h1>
                
                <!-- Create New Admin User -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-danger text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-plus me-2"></i>Create New Admin User
                        </h5>
                    </div>
                    <div class="card-body">
                        <form method="POST" action="{{ url_for('admin.create_admin') }}">
                            <div class="mb-3">
                                <label for="email" class="form-label">User Email</label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="Enter user email" required>
                            </div>
                            <div class="d-grid">
                                <button type="submit" class="btn btn-danger">
                                    <i class="fas fa-user-shield me-1"></i> Grant Admin Privileges
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Summary Cards -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stats-title">Total Users</div>
                            <div class="stats-value text-primary">{{ total_users|default(0) }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-exchange-alt"></i>
                            </div>
                            <div class="stats-title">Total Transactions</div>
                            <div class="stats-value text-info">{{ total_transactions|default(0) }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-flag"></i>
                            </div>
                            <div class="stats-title">Flagged Transactions</div>
                            <div class="stats-value text-warning">{{ flagged_transactions|default(0) }}</div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="stats-card">
                            <div class="stats-icon">
                                <i class="fas fa-envelope"></i>
                            </div>
                            <div class="stats-title">Registered Emails</div>
                            <div class="stats-value text-success">{{ registered_emails|default(0) }}</div>
                        </div>
                    </div>
                </div>
                
                <!-- Transaction Risk Overview (Pie Chart) -->
                <div class="card mb-4 border-0 shadow-sm risk-distribution-card">
                    <div class="card-header bg-gradient-primary text-white risk-distribution-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-pie me-2"></i>System-Wide Transaction Risk Overview
                        </h5>
                    </div>
                    <div class="card-body risk-distribution-body">
                        <div class="chart-container">
                            <canvas id="riskDistributionChart" 
                                    data-low="{{ risk_distribution.low|default(0) }}" 
                                    data-medium="{{ risk_distribution.medium|default(0) }}" 
                                    data-high="{{ risk_distribution.high|default(0) }}"
                                    data-total="{{ total_transactions|default(0) }}"
                                    data-flagged="{{ flagged_transactions|default(0) }}"></canvas>
                        </div>
                        <!-- Custom Legend -->
                        <div class="doughnut-chart-legend">
                            <div class="doughnut-legend-item">
                                <span class="doughnut-legend-color legend-color-low"></span>
                                Low Risk ({{ risk_distribution.low|default(0) }})
                            </div>
                            <div class="doughnut-legend-item">
                                <span class="doughnut-legend-color legend-color-medium"></span>
                                Medium Risk ({{ risk_distribution.medium|default(0) }})
                            </div>
                            <div class="doughnut-legend-item">
                                <span class="doughnut-legend-color legend-color-high"></span>
                                High Risk ({{ risk_distribution.high|default(0) }})
                            </div>
                        </div>
                        <!-- Description -->
                        <p class="mt-3 text-muted text-center">
                            Total Transactions: {{ total_transactions|default(0) }} ({{ flagged_transactions|default(0) }} flagged)<br>
                            {% if risk_distribution.high > 0 %}
                                High-risk transactions detected. Immediate review recommended.
                            {% elif risk_distribution.medium > 0 %}
                                Monitor medium-risk transactions for potential issues.
                            {% else %}
                                Predominantly low-risk transactions indicate strong system security.
                            {% endif %}
                        </p>
                    </div>
                </div>

                <!-- Feature Importance Chart -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar me-2"></i>Feature Importance
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="featureImportanceChart" 
                                    data-features='{{ feature_importance|default({})|tojson|safe }}'></canvas>
                        </div>
                        <table id="featureImportanceTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Feature</th>
                                    <th>Importance</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for feature, importance in feature_importance|default({})|dictsort %}
                                <tr>
                                    <td>{{ feature.replace('_', ' ') }}</td>
                                    <td>{{ (importance * 100)|round(1) }}%</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Monthly Transaction Summary (Line Chart) -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line me-2"></i>System-Wide Monthly Transaction Summary
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="transactionChart" data-transactions='{{ monthly_transactions|default([0,0,0,0,0,0,0,0,0,0,0,0])|tojson|safe }}'></canvas>
                        </div>
                        <p class="mt-3">
                            System-wide transaction activity by month (up to June 2025):<br>
                            {% if monthly_transactions|length > 0 and monthly_transactions|sum > 0 %}
                                {% set months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'] %}
                                {% for i in range(12) %}
                                    {% set count = monthly_transactions[i]|default(0) %}
                                    In {{ months[i] }} {{ current_year|default(2025) }}, the system processed {{ count }} transaction(s).
                                    {% if i > 5 and count == 0 and current_year == 2025 %}
                                        (No data as of June 2025)
                                    {% endif %}
                                    {% if not loop.last %}<br>{% endif %}
                                {% endfor %}
                                {% if monthly_transactions|length > 1 %}
                                    This reflects an average of {{ (monthly_transactions|sum / monthly_transactions|length)|round(2) }} transactions per month across all users.
                                {% endif %}
                            {% else %}
                                No system-wide transaction data is available for the selected period.
                            {% endif %}
                        </p>
                    </div>
                </div>
                
                <!-- Recent Alerts -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-warning text-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-bell me-2"></i>Recent Alerts
                        </h5>
                        <form method="POST" action="{{ url_for('admin.mark_all_read') }}">
                            <button type="submit" class="btn btn-sm btn-outline-light">
                                <i class="fas fa-check-circle me-1"></i> Mark All Read
                            </button>
                        </form>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush">
                            {% if recent_alerts %}
                                {% for alert in recent_alerts %}
                                    <div class="alert alert-{% if alert.priority == 'high' %}danger{% elif alert.priority == 'medium' %}warning{% else %}info{% endif %} mb-0 border-0 rounded-0">
                                        <div class="d-flex justify-content-between">
                                            <div>{{ alert.message }}</div>
                                            <small class="text-muted">{{ alert.timestamp.strftime('%Y-%m-%d %H:%M') }}</small>
                                        </div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="alert alert-secondary mb-0 border-0 rounded-0">No alerts to display</div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Flagged Transactions -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-warning text-white flagged-card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-flag me-2"></i>Flagged Transactions
                        </h5>
                    </div>
                    <div class="card-body flagged-card-body">
                        <div class="table-responsive">
                            <table class="table table-hover flagged-transactions-table admin-table">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-id-badge me-1"></i> ID</th>
                                        <th><i class="fas fa-user me-1"></i> User</th>
                                        <th><i class="fas fa-rupee-sign me-1"></i> Amount</th>
                                        <th><i class="fas fa-user-tag me-1"></i> Recipient</th>
                                        <th><i class="fas fa-exclamation-triangle me-1"></i> Risk</th>
                                        <th><i class="fas fa-calendar me-1"></i> Date</th>
                                        <th><i class="fas fa-cog me-1"></i> Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if flagged_transactions_list %}
                                        {% for txn in flagged_transactions_list %}
                                        <tr class="{% if txn.risk_level == 'High' %}risk-high{% elif txn.risk_level == 'Medium' %}risk-medium{% else %}risk-low{% endif %}">
                                            <td class="txn-id">{{ txn.transaction_id[:8] }}...</td>
                                            <td>{{ txn.user.username }}</td>
                                            <td class="txn-amount">₹{{ txn.amount }}</td>
                                            <td class="txn-recipient">{{ txn.recipient_upi }}</td>
                                            <td>
                                                <span class="risk-badge {{ 'high' if txn.risk_level == 'High' else 'medium' if txn.risk_level == 'Medium' else 'low' }}">
                                                    {{ txn.risk_level }}
                                                </span>
                                            </td>
                                            <td class="txn-timestamp">{{ txn.timestamp.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td class="flagged-actions admin-actions">
                                                <div class="btn-group">
                                                    <form method="POST" action="{{ url_for('admin.unflag_transaction', txn_id=txn.id) }}" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-outline-success">
                                                            <i class="fas fa-check me-1"></i> Unflag
                                                        </button>
                                                    </form>
                                                    <form method="POST" action="{{ url_for('admin.delete_transaction', txn_id=txn.id) }}" class="d-inline">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-trash me-1"></i> Delete
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="7" class="flagged-empty-state">
                                                <i class="fas fa-info-circle"></i><br>
                                                No flagged transactions
                                            </td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <!-- Pagination for Flagged Transactions -->
                {% if pagination and pagination.pages > 1 %}
                <nav aria-label="Flagged Transactions Pagination" class="flagged-pagination">
                    <ul class="pagination justify-content-center mt-3">
                        <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.flagged_transactions', page=pagination.prev_num) if pagination.has_prev else '#' }}">Previous</a>
                        </li>
                        {% for page_num in pagination.iter_pages() %}
                            {% if page_num %}
                                <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                    <a class="page-link" href="{{ url_for('admin.flagged_transactions', page=page_num) }}">{{ page_num }}</a>
                                </li>
                            {% else %}
                                <li class="page-item disabled"><span class="page-link">...</span></li>
                            {% endif %}
                        {% endfor %}
                        <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                            <a class="page-link" href="{{ url_for('admin.flagged_transactions', page=pagination.next_num) if pagination.has_next else '#' }}">Next</a>
                        </li>
                    </ul>
                </nav>
                {% endif %}

                <!-- User Management -->
                <div class="card mb-4 border-0 shadow-sm">
                    <div class="card-header bg-gradient-primary text-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-user-cog me-2"></i>User Management
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover admin-table">
                                <thead class="table-light">
                                    <tr>
                                        <th><i class="fas fa-user me-1"></i> Username</th>
                                        <th><i class="fas fa-envelope me-1"></i> Email</th>
                                        <th><i class="fas fa-calendar-plus me-1"></i> Created At</th>
                                        <th><i class="fas fa-exchange-alt me-1"></i> Transactions</th>
                                        <th><i class="fas fa-cog me-1"></i> Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if users|default([]) %}
                                        {% for user in users %}
                                        <tr>
                                            <td>{{ user.username }}</td>
                                            <td>{{ user.email }}</td>
                                            <td>{{ user.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                                            <td>{{ user.transaction_count|default(0) }}</td>
                                            <td>
                                                <div class="btn-group admin-actions">
                                                    <form method="POST" action="{{ url_for('admin.delete_user', user_id=user.id) }}" 
                                                          onsubmit="return confirm('Are you sure you want to delete this user?');">
                                                        <button type="submit" class="btn btn-sm btn-outline-danger">
                                                            <i class="fas fa-trash me-1"></i> Delete
                                                        </button>
                                                    </form>
                                                    {% if current_user.is_authenticated and current_user.can_promote_users and not user.promoted_by_id %}
                                                    <form method="POST" action="{{ url_for('admin.promote_to_admin', user_id=user.id) }}" class="d-inline ms-1">
                                                        <button type="submit" class="btn btn-sm btn-outline-primary">
                                                            <i class="fas fa-user-shield me-1"></i> Promote
                                                        </button>
                                                    </form>
                                                    {% endif %}
                                                    <button class="btn btn-sm btn-outline-info ms-1 view-security-btn" 
                                                            data-user-id="{{ user.id }}" 
                                                            data-bs-toggle="tooltip" 
                                                            title="View security details">
                                                        <i class="fas fa-lock me-1"></i> Security
                                                    </button>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="5" class="text-center py-4 text-muted">No users to display</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                        <!-- Pagination for Users -->
                        {% if pagination and pagination.pages > 1 %}
                        <nav aria-label="User Pagination">
                            <ul class="pagination justify-content-center mt-3">
                                <li class="page-item {% if not pagination.has_prev %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('admin.user_management', page=pagination.prev_num, search=search|default('')) if pagination.has_prev else '#' }}">Previous</a>
                                </li>
                                {% for page_num in pagination.iter_pages() %}
                                    {% if page_num %}
                                        <li class="page-item {% if page_num == pagination.page %}active{% endif %}">
                                            <a class="page-link" href="{{ url_for('admin.user_management', page=page_num, search=search|default('')) }}">{{ page_num }}</a>
                                        </li>
                                    {% else %}
                                        <li class="page-item disabled"><span class="page-link">...</span></li>
                                    {% endif %}
                                {% endfor %}
                                <li class="page-item {% if not pagination.has_next %}disabled{% endif %}">
                                    <a class="page-link" href="{{ url_for('admin.user_management', page=pagination.next_num, search=search|default('')) if pagination.has_next else '#' }}">Next</a>
                                </li>
                            </ul>
                        </nav>
                        {% endif %}
                    </div>
                </div>

                <!-- Security Modal -->
                <div class="modal fade" id="securityModal" tabindex="-1" aria-labelledby="securityModalLabel" aria-hidden="true">
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-gradient-primary text-white">
                                <h5 class="modal-title" id="securityModalLabel">User Security Details</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Username</label>
                                        <input type="text" class="form-control-plaintext" id="modalUsername" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Email</label>
                                        <input type="text" class="form-control-plaintext" id="modalEmail" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Account Created</label>
                                        <input type="text" class="form-control-plaintext" id="modalCreatedAt" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label fw-bold">Last Login</label>
                                        <input type="text" class="form-control-plaintext" id="modalLastLogin" readonly>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label fw-bold">Security Question</label>
                                        <input type="text" class="form-control-plaintext" id="modalSecurityQuestion" readonly>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label fw-bold">Security Answer Hash</label>
                                        <textarea class="form-control-plaintext font-monospace" id="modalSecurityAnswer" rows="2" readonly></textarea>
                                    </div>
                                    <div class="col-md-12 mb-3">
                                        <label class="form-label fw-bold">Password Hash</label>
                                        <textarea class="form-control-plaintext font-monospace" id="modalPasswordHash" rows="3" readonly></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/main.js') }}"></script>
<script src="{{ url_for('static', filename='js/charts.js') }}"></script>
<script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
